<!DOCTYPE html>
<html>
	<head>
		<title>Prose Generator</title>
		<link rel="stylesheet" type="text/css" href="ProseGenerator.css">
		<script type="text/javascript" src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
		<script>
		var associativeArray = {};
		var type;
		var subtype;
		var currentFileNames = [];
		var addedScript;
		var currentItem = 0;
		var fileReq = new XMLHttpRequest();
		var baseURL = "http://people.rit.edu/tcg3234/RPGSeminarProject/";
			window.onload = function(){
				var x = document.getElementsByClassName("Type_Selector");
				var i;
				
				
				
				
				function makeSubTypesVisible(e){
					document.getElementById("Type_SubBar").style.visibility = "visible";
				
					type = e.target.innerHTML;
				}
				
				
				for(i=0;i<x.length; i++){
					x[i].onclick = makeSubTypesVisible;
				}
				
				document.getElementById('prev').onclick = function(){
					if(currentItem-1 < 0)
					{
						currentItem = currentFileNames.length-1;
					}
					else{
					currentItem--;
					}
					addedScript = document.createElement("script");
					addedScript.setAttribute('src', baseURL + 'getFileContents.php?fp='+type+'/'+subtype+'/'+currentFileNames[currentItem]+"&callback=handleTextResponse");
					document.head.appendChild(addedScript);
				}
				
				document.getElementById('next').onclick = function(){
					if(currentItem+1 >= currentFileNames.length)
					{
						currentItem = 0;
					}
					else
					{
					currentItem++;
					}
					addedScript = document.createElement("script");
					addedScript.setAttribute('src', baseURL + 'getFileContents.php?fp='+type+'/'+subtype+'/'+currentFileNames[currentItem]+"&callback=handleTextResponse");
					document.head.appendChild(addedScript);
				}
				
				
				var subtypeButton = document.getElementsByClassName('subtype_selector');
				for(i=0; i < subtypeButton.length; i++){
					subtypeButton[i].onclick = function(e){
						subtype = e.target.innerHTML;
						addedScript = document.createElement("script");
						addedScript.setAttribute('src', baseURL + 'getFolderAsArrayOfNames.php?direct='+type+'/'+subtype+"&callback=handleResponse");
						document.head.appendChild(addedScript);
						
					}
				}
				
				
				
			}
			
			function handleResponse(data){
				currentItem = 0;
				document.head.removeChild(addedScript);
				currentFileNames = [];
				for(var i=0; i < data.length; i++)
				{
					if(data[i].indexOf(".txt") != -1){
						currentFileNames.push(data[i]);
					}
				}
				if(currentFileNames.length > 0)
				{
					addedScript = document.createElement("script");
					addedScript.setAttribute('src', baseURL + 'getFileContents.php?fp='+type+'/'+subtype+'/'+currentFileNames[currentItem]+"&callback=handleTextResponse");
					document.head.appendChild(addedScript);
				}
				
			}
			
			function handleTextResponse(data){
				document.head.removeChild(addedScript);
				var displayArea = document.getElementById('Prose_content');
				var allText = data;
				displayArea.innerHTML = parseResult(allText);
						
				for(var key in associativeArray){
					var current = document.getElementById(key);
							
					current.onchange = function(e){
						var id = e.target.id;
						var doubleKey = id+id;
						var halfKey = id.substring(0,Math.ceil(id.length/2));
						if(associativeArray[doubleKey]){
							document.getElementById(doubleKey).selectedIndex = e.target.selectedIndex;
						}
						else if(associativeArray[halfKey]){
							document.getElementById(halfKey).selectedIndex = e.target.selectedIndex;
						}
					}
				}
			}
			
			function parseResult(result)
			{
				associativeArray = {};
				var innerHTML = "";
				
				var choice = "";
				var choices = [];
				var num = "";
				var character;
				var checkChoices = false;
				for(i=0;i<result.length;i++)
				{
					character = result[i];
					if(checkChoices){
						if(character == '|'){
							choices.push(choice);
							choice = "";
							continue;
						}
						else if(isNumber(character))
						{
							while(isNumber(result[i+1])){
								i++;
							}
							choices.push(choice);
							associativeArray[num] = choices;
							
							innerHTML+="<select id='"+num+"'>";
							
							for(x=0;x<associativeArray[num].length;x++){
								innerHTML += "<option value='"+associativeArray[num][x]+"'>"+associativeArray[num][x]+"</option>";
							}
							
							innerHTML+="</select>";
							num="";
							choice = "";
							choices = [];
							checkChoices = false;
							continue;
						}
						else
							choice += character;
					}
					
					else if(isNumber(character)){
						num+= character;
						while(isNumber(result[i+1])){
							i++;
							character = result[i];
							num+=character;
						}
						checkChoices = true;
					}
					
					else {
						if(character == '\\' && result[i+1] == 'n')
						{
							innerHTML+="<br>";
							i++;
						}
						else
							innerHTML+=character;
					}
				}
				
				return(innerHTML);
			}
			
			function isNumber(n) {

				return !isNaN(parseFloat(n)) && isFinite(n);

			}
		</script>
	</head>
	
	<body>
		<div id="Type_Bar">
			<button class="Type_Selector">Riddle</button>
			<button class="Type_Selector">Prophecy</button>
			<button class="Type_Selector">Instructions</button>
			<button class="Type_Selector">Bardic</button>
			<div id="Type_SubBar">
				<button class="subtype_selector" id="subtype_selector">Warning</button>
				<button class="subtype_selector" id="subtype_selector">Humor</button>
				<button class="subtype_selector" id="subtype_selector">Epic</button>
				<button class="subtype_selector" id="subtype_selector">Horror</button>
				<button class="subtype_selector" id="subtype_selector">Shanties</button>
			</div>
		</div>
		<div id="Prose_content"></div>
		<div id="Left_Arrow" style="float:left;"><button id="prev"><</a></div>
		<div id="Right_Arrow" style="float:right;"><button id="next">></a></div>
	</body>
</html>