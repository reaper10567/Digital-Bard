<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Poetry Generator</title>
		<link href='https://fonts.googleapis.com/css?family=IM Fell English SC' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" type="text/css" href="ProseGenerator.css">
		<script type="text/javascript" src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
		<script>
		var associativeArray = {};
		var type;
		var subtype;
		var currentFileNames = [];
		var addedScript;
		var currentItem = 0;
		var fileReq = new XMLHttpRequest();
		var baseURL = "http://people.rit.edu/tcg3234/RPGSeminarProject/";
		var blackListedId = [];
			window.onload = function(){
				var x = document.getElementsByClassName("Type_Selector");
				var i;
				
				
				
				
				function makeSubTypesVisible(e){
					// make the sub bar visible
					document.getElementById("Type_SubBar").style.visibility = "visible";
					// set the super type to the word
					type = e.target.innerHTML;
					// move the sub bar to the super button
					e.target.parentNode.appendChild(document.getElementById("Type_SubBar"));
				}
				
				
				for(i=0;i<x.length; i++){
					x[i].onclick = makeSubTypesVisible;
				}
				
				document.getElementById('prev').onclick = function(){
					if(currentItem-1 < 0)
					{
						currentItem = currentFileNames.length-1;
					}
					else{
					currentItem--;
					}
					addedScript = document.createElement("script");
					addedScript.setAttribute('src', baseURL + 'getFileContents.php?fp='+type+'/'+subtype+'/'+currentFileNames[currentItem]+"&callback=handleTextResponse");
					document.head.appendChild(addedScript);
				}
				
				document.getElementById('next').onclick = function(){
					if(currentItem+1 >= currentFileNames.length)
					{
						currentItem = 0;
					}
					else
					{
					currentItem++;
					}
					addedScript = document.createElement("script");
					addedScript.setAttribute('src', baseURL + 'getFileContents.php?fp='+type+'/'+subtype+'/'+currentFileNames[currentItem]+"&callback=handleTextResponse");
					document.head.appendChild(addedScript);
				}
				
				
				var subtypeButton = document.getElementsByClassName('subtype_selector');
				for(i=0; i < subtypeButton.length; i++){
					subtypeButton[i].onclick = function(e){
						subtype = e.target.innerHTML;
						addedScript = document.createElement("script");
						addedScript.setAttribute('src', baseURL + 'getFolderAsArrayOfNames.php?direct='+type+'/'+subtype+"&callback=handleResponse");
						document.head.appendChild(addedScript);
						document.getElementById("Type_SubBar").style.visibility = "none";
					}
				}
				
				handleTextRespone("A Digital Bard; what is it, you ask? \n I'm glad that you posed such a question. \n A Bard helps DMs with their difficult task; \n Preparing cool stuff for each session. \n \n A DM (or GM; whatever you like) \n Could benefit well from this tool;  \n So too could a player who's fond of the mic;  \n Quick poems just make things sound cool. \n \n But Digital Bard goes a step beyond that \n To provide you with supplementation! \n Each poem is 1changeable|mutable|protean1; filled up and fat \n With a slew of swap customization! \n \n Now don't take my word for it; go out and see \n The wonders this app holds for you! \n And if you are generous, credit these three:  \n 2Sarah|Bishop2 3Tyler|Gerber3 and 4Ben|Connick4 are the crew. \n");	
				
			}
			
			function handleResponse(data){
				currentItem = 0;
				document.head.removeChild(addedScript);
				currentFileNames = [];
				for(var i=0; i < data.length; i++)
				{
					if(data[i].indexOf(".txt") != -1){
						currentFileNames.push(data[i]);
					}
				}
				if(currentFileNames.length > 0)
				{
					addedScript = document.createElement("script");
					addedScript.setAttribute('src', baseURL + 'getFileContents.php?fp='+type+'/'+subtype+'/'+currentFileNames[currentItem]+"&callback=handleTextResponse");
					document.head.appendChild(addedScript);
				}
				
			}
			
			function handleTextResponse(data){
				if(addedScript != null)
					document.head.removeChild(addedScript);
				var displayArea = document.getElementById('Prose_content');
				var allText = data;
				displayArea.innerHTML = parseResult(allText);
						
				for(var key in associativeArray){
					var current = document.getElementById(key);
							
					current.onchange = function(e){
							blackListedId.push(e.target.id);
							var id = e.target.id;
							var doubleKey = id+id;
							var halfKey = id.substring(0,Math.ceil(id.length/2));
							if(associativeArray[doubleKey] && blackListedId.indexOf(doubleKey) == -1){
								document.getElementById(doubleKey).selectedIndex = e.target.selectedIndex;
								document.getElementById(doubleKey).onchange({target: document.getElementById(doubleKey)});
							}
							if(associativeArray[halfKey] && blackListedId.indexOf(halfKey) == -1){
								document.getElementById(halfKey).selectedIndex = e.target.selectedIndex;
								document.getElementById(halfKey).onchange({target: document.getElementById(halfKey)});
							}
							
							if(e.target.id == blackListedId[0])
							{
								blackListedId = [];
							}
						
					}
				}
			}
			
			function parseResult(result)
			{
				associativeArray = {};
				var innerHTML = "";
				
				var choice = "";
				var choices = [];
				var num = "";
				var character;
				var checkChoices = false;
				for(i=0;i<result.length;i++)
				{
					character = result[i];
					if(checkChoices){
						if(character == '|'){
							choices.push(choice);
							choice = "";
							continue;
						}
						else if(isNumber(character))
						{
							while(isNumber(result[i+1])){
								i++;
							}
							choices.push(choice);
							associativeArray[num] = choices;
							
							innerHTML+="<select id='"+num+"'>";
							
							for(x=0;x<associativeArray[num].length;x++){
								innerHTML += "<option value='"+associativeArray[num][x]+"'>"+associativeArray[num][x]+"</option>";
							}
							
							innerHTML+="</select>";
							num="";
							choice = "";
							choices = [];
							checkChoices = false;
							continue;
						}
						else
							choice += character;
					}
					
					else if(isNumber(character)){
						num+= character;
						while(isNumber(result[i+1])){
							i++;
							character = result[i];
							num+=character;
						}
						checkChoices = true;
					}
					
					else {
						if(character == '\n')
						{
							innerHTML+="<br>";
							i++;
						}
						else
							innerHTML+=character;
					}
				}
				
				return(innerHTML);
			}
			
			function isNumber(n) {

				return !isNaN(parseFloat(n)) && isFinite(n);

			}
		</script>
	</head>
	
	<body>
		<div id="Type_Bar">
			<table class="Type_Table"><tr>
			<td><div class="logo">Digital Bard</div></td>
			<td><button class="Type_Selector">Riddle</button></td>
			<td><button class="Type_Selector">Prophecy</button></td>
			<td><button class="Type_Selector">Instructions</button></td>
			<td><button class="Type_Selector">Bardic</button></td>
			</tr></table>
			<div id="Type_SubBar">
				<button class="subtype_selector" id="subtype_selector">Warning</button>
				<button class="subtype_selector" id="subtype_selector">Humor</button>
				<button class="subtype_selector" id="subtype_selector">Epic</button>
				<button class="subtype_selector" id="subtype_selector">Horror</button>
				<button class="subtype_selector" id="subtype_selector">Shanties</button>
			</div>
		</div>
		<div id="Prose_content"></div>
		<div id="Left_Arrow" style="float:left;"><button id="prev"><</a></div>
		<div id="Right_Arrow" style="float:right;"><button id="next">></a></div>
	</body>
</html>
